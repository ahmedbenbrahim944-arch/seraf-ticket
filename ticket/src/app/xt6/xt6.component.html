<div class="print-container">
  <div class="form-wrapper">
    <div class="form-container">
      <div class="form-header">
        <h3 class="form-title">Imprimer ticket XT6 </h3>
        <button class="btn-back" (click)="goBack()" title="Retour">
          <i class="bi bi-arrow-left"></i>
        </button>
      </div>

     <!-- Section Mat√©riels utilis√©s -->
     <div class="materials-section">
  <h4 class="materials-title">Mat√©riels utilis√©s</h4>
  <div class="materials-container">
    <!-- RESIN RIBBON -->
    <div class="material-item">
      <div class="material-title"> RESIN RIBBON</div>
      <div class="material-image-wrapper" (click)="openImageModal('assets/images/ribon.jpg')">
        <img src="assets/images/ribon.jpg" 
             alt="Energy Stand" 
             class="material-image"
             title="PUSH ENERGY STAND">
      </div>
    </div>
    
    <!-- Tickets -->
    <div class="material-item">
      <div class="material-title"> TICKETS</div>
      <div class="material-image-wrapper" (click)="openImageModal('assets/images/polo.png')">
        <img src="assets/images/polo.png"
             alt="Energy Stand 2"
             class="material-image"
             title="PUSH ENERGY STAND">
      </div>
    </div>
    
    <!-- Ajuster tickets -->
    <div class="material-item">
      <div class="material-title"> AJUSTER TICKETS</div>
      <div class="material-image-wrapper" (click)="openImageModal('assets/images/2cm.png')">
        <img src="assets/images/2cm.png"
             alt="Mat√©riel suppl√©mentaire"
             class="material-image"
             title="Mat√©riel suppl√©mentaire">
      </div>
    </div>
  </div>
</div>

      <!-- Modal pour l'image agrandie -->
      <div class="image-modal-overlay" *ngIf="showImageModal" (click)="closeImageModal()">
        <div class="image-modal-content" (click)="$event.stopPropagation()">
          <button class="btn-close-modal" (click)="closeImageModal()" aria-label="Fermer l'image">
            <i class="bi bi-x"></i>
          </button>
          <img [src]="selectedImage" alt="Image agrandie" class="enlarged-image">
        </div>
      </div>
      <!-- üÜï Ajoutez ceci APR√àS la section "Mat√©riels utilis√©s" et AVANT le formulaire -->

<!-- Avertissement de changement de semaine -->
<div class="week-warning-banner" *ngIf="weekChangeDetected" role="alert">
  <div class="warning-icon">
    <i class="bi bi-exclamation-triangle-fill"></i>
  </div>
  <div class="warning-content">
    <h4 class="warning-title">‚ö†Ô∏è Changement de Semaine D√©tect√©</h4>
    <p class="warning-message">
      Semaine actuelle : <strong>{{ weekChangeInfo.currentWeek }}</strong>
      <i class="bi bi-arrow-right mx-2"></i>
      Nouvelle semaine : <strong>{{ weekChangeInfo.newWeek }}</strong>
    </p>
    <p class="warning-detail">
      <i class="bi bi-info-circle"></i>
      Le num√©ro progressif sera automatiquement remis √† <strong>0001</strong>
    </p>
  </div>
</div>
      <form (ngSubmit)="onPrint()" #printForm="ngForm">
        <!-- Ligne -->
        <div class="form-group">
          <label for="selectedLigne" class="form-label">
            Ligne <span class="required-asterisk">*</span>
          </label>
          <select 
            id="selectedLigne"
            class="form-input" 
            [(ngModel)]="selectedLigne"
            name="selectedLigne" 
            (change)="onLigneChange()"
            required
            aria-required="true">
            <option value="L37:MXT6">L37:MXT6</option>
          </select>
          <div class="form-hint">
            Ligne pr√©d√©finie pour XT6 - Non modifiable
          </div>
        </div>

        <!-- R√©f√©rence -->
        <div class="form-group">
          <label for="selectedReference" class="form-label">
            R√©f√©rence <span class="required-asterisk">*</span>
          </label>
          <select 
            id="selectedReference"
            class="form-input" 
            [(ngModel)]="selectedReference"
            name="selectedReference" 
            (change)="onReferenceChange()"
            [disabled]="!selectedLigne"
            required
            aria-required="true">
            <option value="">S√©lectionnez une r√©f√©rence</option>
            <option *ngFor="let reference of references" [value]="reference">{{ reference }}</option>
          </select>
          <div class="error-message" *ngIf="!selectedReference && errorMessage" role="alert">
            La r√©f√©rence est requise
          </div>
        </div>

        <!-- Code Produit -->
        <div class="form-group">
          <label for="codeProduit" class="form-label">Code Produit</label>
          <input 
            id="codeProduit"
            type="text" 
            class="form-input" 
            [(ngModel)]="codeProduit"
            name="codeProduit" 
            readonly
            placeholder="Code produit auto-g√©n√©r√©">
        </div>
        
        <!-- Date -->
        <div class="form-group">
          <label for="selectedDate" class="form-label">Date</label>
          <input 
            id="selectedDate"
            type="date" 
            class="form-input" 
            [(ngModel)]="selectedDate"
            name="selectedDate" 
            required
            aria-required="true">
        </div>

        <!-- Matricule (Unique Code) -->
        <div class="form-group">
          <label for="matricule" class="form-label">
            Unique Code <span class="required-asterisk">*</span>
          </label>
          <input 
            id="matricule"
            type="text" 
            class="form-input" 
            [(ngModel)]="matricule"
            name="matricule" 
            required
            aria-required="true"
            placeholder="Votre code unique">
          <div class="error-message" *ngIf="!matricule && errorMessage" role="alert">
            Le code unique est requis
          </div>
        </div>

        <!-- N¬∞ Progressive -->
        <div class="form-group">
          <label for="numeroProgressive" class="form-label">N¬∞ Progressive</label>
          <input 
            id="numeroProgressive"
            type="text" 
            class="form-input" 
            [(ngModel)]="numeroProgressive"
            name="numeroProgressive" 
            readonly
            placeholder="N¬∞ progressive auto-g√©n√©r√©">
        </div>

        <!-- Fournisseur -->
        <div class="form-group">
          <label for="selectedMode" class="form-label">
            Fournisseur <span class="required-asterisk">*</span>
          </label>
          <select 
            id="selectedMode"
            class="form-input" 
            [(ngModel)]="selectedMode"
            name="selectedMode" 
            required
            aria-required="true">
            <option value="M0">M0</option>
            <option value="M1">M1</option>
          </select>
        </div>

        <!-- Indice -->
        <div class="form-group">
          <label for="indice" class="form-label">Indice</label>
          <input 
            id="indice"
            type="text" 
            class="form-input" 
            [(ngModel)]="indice"
            name="indice" 
            readonly
            placeholder="Indice par d√©faut">
        </div>

        <!-- Quantit√© -->
        <div class="form-group">
          <label for="quantite" class="form-label">
            Quantit√© <span class="required-asterisk">*</span>
          </label>
          <input 
            id="quantite"
            type="number" 
            class="form-input" 
            [(ngModel)]="quantite"
            name="quantite" 
            min="1"
            required
            aria-required="true"
            placeholder="Nombre de tickets √† imprimer">
          <div class="error-message" *ngIf="!quantite && errorMessage" role="alert">
            La quantit√© est requise
          </div>
        </div>

        <!-- Configuration imprimante -->
        <div class="form-group" *ngIf="availablePrinters.length > 0">
          <label for="selectedPrinter" class="form-label">Imprimante</label>
          <div class="printer-selection">
            <select 
              id="selectedPrinter"
              class="form-input" 
              [(ngModel)]="selectedPrinter"
              name="selectedPrinter">
              <option value="">S√©lectionnez une imprimante</option>
              <option *ngFor="let printer of availablePrinters" [value]="printer.name">
                {{ printer.displayName }} 
                <span *ngIf="printer.isTSC">(TSC Compatible)</span>
                <span *ngIf="printer.isDefault">(Par d√©faut)</span>
              </option>
            </select>
            <button 
              type="button" 
              class="btn-test-printer" 
              (click)="testSelectedPrinter()"
              [disabled]="!selectedPrinter">
              <i class="bi bi-printer"></i> Test
            </button>
          </div>
          <div class="printer-status" *ngIf="showPrinterTest" role="status">
            <small [class]="printerTestResult.includes('succ√®s') ? 'success-text' : 'error-text'">
              {{ printerTestResult }}
            </small>
          </div>
        </div>

        <!-- Boutons -->
        <div class="button-group">
          <button 
            type="button" 
            class="btn-cancel" 
            (click)="onCancel()">
            <i class="bi bi-x-circle"></i> 
            <span>Annuler</span>
          </button>
          
          <button 
            type="submit" 
            class="btn-print"
            [disabled]="isLoading"
             (click)="confirmPrint()"
            [attr.aria-busy]="isLoading">
            <i class="bi bi-printer"></i>
            <span *ngIf="!isLoading">Imprimer</span>
            <span *ngIf="isLoading">Traitement...</span>
          </button>
        </div>
        
        <div class="error-message server-error" *ngIf="errorMessage" role="alert">
          <i class="bi bi-exclamation-triangle"></i>
          {{ errorMessage }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Dialogue d'impression -->


<!-- Dialogue de r√©sultat d'impression -->
<div class="print-result-overlay" *ngIf="showPrintResult" role="dialog" aria-modal="true">
  <div class="print-result-dialog">
    <div class="dialog-header">
      <h3>Impression r√©ussie</h3>
      <button class="btn-close" (click)="closePrintResult()" aria-label="Fermer">
        <i class="bi bi-x"></i>
      </button>
    </div>
    
    <div class="dialog-body">
      <div class="print-success-message">
        <i class="bi bi-check-circle-fill"></i>
        <p>{{ printResult?.data?.summary?.totalTickets }} tickets XT6 imprim√©s</p>
        <small>Format: 17x7mm - Impression successive</small>
      </div>
      
      <div class="print-summary">
        <h4>R√©sum√© :</h4>
        <ul>
          <li><strong>Plage progressive :</strong> {{ printResult?.data?.summary?.progressiveRange }}</li>
          <li><strong>Job ID :</strong> {{ printResult?.data?.printJobId }}</li>
          <li><strong>Ligne :</strong> {{ printResult?.data?.summary?.productInfo?.ligne }}</li>
          <li><strong>R√©f√©rence :</strong> {{ printResult?.data?.summary?.productInfo?.reference }}</li>
          <li><strong>Mode :</strong> Successif (ticket par ticket)</li>
        </ul>
      </div>
      
      <div class="tickets-preview">
        <h4>Aper√ßu des tickets :</h4>
        <div class="tickets-container">
          <div class="ticket-item" *ngFor="let ticket of printedTickets.slice(0, 8)">
            <div class="ticket-qr">
<img [src]="ticket.codeImage" 
     [alt]="(ticket.codeType || 'Code') + ' du ticket ' + ticket.progressiveNumber"
     class="qr-code-image">            </div>
            <div class="ticket-info">
              <div class="ticket-progressive">{{ ticket.progressiveNumber }}</div>
              <div class="ticket-xt6">XT6</div>
              <div class="ticket-matricule">{{ ticket.matricule }}</div>
              <div class="ticket-fullnumber">{{ ticket.ligne }}-{{ ticket.reference }}</div>
            </div>
          </div>
        </div>
        
        <div class="tickets-more" *ngIf="printedTickets.length > 8">
          <p>... et {{ printedTickets.length - 8 }} tickets suppl√©mentaires</p>
        </div>
      </div>
    </div>
    
    <div class="dialog-footer">
      <button class="btn-primary" (click)="closePrintResult()">
        Fermer
      </button>
    </div>
  </div>
</div>